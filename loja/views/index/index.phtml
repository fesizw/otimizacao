<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loja Virtual - Produtos</title>

    <!-- CSS Crítico Inline para First Contentful Paint rápido -->
    <style>
        <?php include $_SERVER['DOCUMENT_ROOT'] . '/publico/css/critical.css'; ?>
    </style>

    <!-- Preload de fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- CSS não-crítico carregado de forma assíncrona -->
    <link rel="preload" href="/publico/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/publico/css/fontawesome.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/publico/css/style.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link href="/publico/css/bootstrap.min.css" rel="stylesheet">
        <link href="/publico/css/fontawesome.min.css" rel="stylesheet">
        <link href="/publico/css/style.min.css" rel="stylesheet">
    </noscript>
</head>

<body class="home">

    <!-- Banner principal -->
    <div class="hero-banner">
        <?php foreach ($this->banners as $index => $banner) { ?>
            <div class="banner-slide <?= $index === 0 ? 'current' : '' ?>" style="background-image: url('<?= htmlspecialchars($banner->imagem) ?>');">
                <div class="carousel-caption">
                    <h1><?= htmlspecialchars($banner->titulo) ?></h1>
                    <?php if ($banner->descricao) { ?>
                        <p><?= htmlspecialchars($banner->descricao) ?></p>
                    <?php } ?>
                </div>
            </div>
        <?php } ?>
    </div>

    <div class="container">
        <!-- Sistema de busca -->
        <div class="search-wrapper">
            <div class="input-group">
                <input type="text" class="form-control" id="productSearch" placeholder="Buscar produtos...">
                <button class="btn btn-primary" id="btnSearch">Buscar</button>
            </div>
        </div>

        <div class="row">
            <!-- Painel de filtros -->
            <div class="col-md-3">
                <div class="filter-panel">
                    <h4>Filtros</h4>

                    <div class="filter-section">
                        <h6>Categoria</h6>
                        <div id="categoryFilters">
                            <!-- Será preenchido dinamicamente -->
                        </div>
                    </div>

                    <div class="filter-section mt-3">
                        <h6>Preço</h6>
                        <div id="priceFilters">
                            <div class="filter-group">
                                <input type="checkbox" id="price-0-50" value="0-50" class="price-filter">
                                <label for="price-0-50">R$ 0 - R$ 50</label>
                            </div>
                            <div class="filter-group">
                                <input type="checkbox" id="price-50-100" value="50-100" class="price-filter">
                                <label for="price-50-100">R$ 50 - R$ 100</label>
                            </div>
                            <div class="filter-group">
                                <input type="checkbox" id="price-100-500" value="100-500" class="price-filter">
                                <label for="price-100-500">R$ 100 - R$ 500</label>
                            </div>
                            <div class="filter-group">
                                <input type="checkbox" id="price-500+" value="500+" class="price-filter">
                                <label for="price-500+">R$ 500+</label>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary mt-3" id="btnApplyFilters">Aplicar Filtros</button>
                    <button class="btn btn-secondary mt-2" id="btnClearFilters">Limpar Filtros</button>
                </div>
            </div>

            <!-- Grade de produtos -->
            <div class="col-md-9">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span id="productCount">Carregando produtos...</span>
                </div>
                <div id="productGrid" class="row">
                    <!-- Produtos aparecerão aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/publico/js/jquery.min.js"></script>
    <script src="/publico/js/bootstrap.bundle.min.js"></script>

    <script>
        (function() {
            'use strict';

            let allProducts = [];
            let filteredProducts = [];

            const elements = {
                productGrid: document.getElementById('productGrid'),
                productCount: document.getElementById('productCount'),
                categoryFilters: document.getElementById('categoryFilters'),
                searchInput: document.getElementById('productSearch'),
                btnSearch: document.getElementById('btnSearch'),
                btnApplyFilters: document.getElementById('btnApplyFilters'),
                btnClearFilters: document.getElementById('btnClearFilters')
            };

            async function init() {
                try {
                    allProducts = await fetchProducts();
                    filteredProducts = [...allProducts];

                    buildCategoryFilters();
                    renderProducts(filteredProducts);
                    setupEventListeners();
                    startBannerRotation();
                } catch (error) {
                    console.error('Erro ao carregar produtos:', error);
                    elements.productGrid.innerHTML = '<p class="text-danger">Erro ao carregar produtos.</p>';
                }
            }

            async function fetchProducts() {
                const response = await fetch('/index/products');
                if (!response.ok) throw new Error('Falha ao buscar produtos');
                return response.json();
            }

            function buildCategoryFilters() {
                const categories = [...new Set(allProducts.map(p => p.categoria))].sort();

                elements.categoryFilters.innerHTML = categories.map(cat => `
            <div class="filter-group">
                <input type="checkbox" id="cat-${slugify(cat)}" value="${escapeHtml(cat)}" class="category-filter">
                <label for="cat-${slugify(cat)}">${escapeHtml(cat)}</label>
            </div>
        `).join('');
            }

            function renderProducts(products) {
                elements.productCount.textContent = `${products.length} produto(s) encontrado(s)`;

                if (products.length === 0) {
                    elements.productGrid.innerHTML = '<p class="text-muted">Nenhum produto encontrado.</p>';
                    return;
                }

                elements.productGrid.innerHTML = products.map(product => `
            <div class="col-md-4 mb-4">
                <div class="product-item" onclick="window.location='/index/detalhes/id/${product.id_produtos}'">
                    <img src="${escapeHtml(product.imagem || 'https://via.placeholder.com/300x200')}" 
                         alt="${escapeHtml(product.nome)}" 
                         class="product-thumbnail"
                         loading="lazy">
                    <h5>${escapeHtml(product.nome)}</h5>
                    <p class="text-muted">Categoria: ${escapeHtml(product.categoria)}</p>
                    <h4>R$ ${formatPrice(product.preco)}</h4>
                    <button class="btn btn-primary btn-sm">Comprar Agora</button>
                </div>
            </div>
        `).join('');
            }

            function applyFilters() {
                const selectedCategories = getSelectedValues('.category-filter');
                const selectedPrices = getSelectedValues('.price-filter');
                const searchTerm = elements.searchInput.value.toLowerCase().trim();

                filteredProducts = allProducts.filter(product => {
                    if (selectedCategories.length > 0 && !selectedCategories.includes(product.categoria)) {
                        return false;
                    }

                    if (selectedPrices.length > 0) {
                        const price = parseFloat(product.preco);
                        const matchesPrice = selectedPrices.some(range => {
                            if (range === '0-50') return price >= 0 && price <= 50;
                            if (range === '50-100') return price > 50 && price <= 100;
                            if (range === '100-500') return price > 100 && price <= 500;
                            if (range === '500+') return price > 500;
                            return false;
                        });
                        if (!matchesPrice) return false;
                    }

                    if (searchTerm && !product.nome.toLowerCase().includes(searchTerm)) {
                        return false;
                    }

                    return true;
                });

                renderProducts(filteredProducts);
            }

            function clearFilters() {
                document.querySelectorAll('.category-filter, .price-filter').forEach(cb => cb.checked = false);
                elements.searchInput.value = '';
                filteredProducts = [...allProducts];
                renderProducts(filteredProducts);
            }

            function setupEventListeners() {
                elements.btnApplyFilters.addEventListener('click', applyFilters);
                elements.btnClearFilters.addEventListener('click', clearFilters);
                elements.btnSearch.addEventListener('click', applyFilters);
                elements.searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') applyFilters();
                });

                let searchTimeout;
                elements.searchInput.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(applyFilters, 300);
                });
            }

            function startBannerRotation() {
                const slides = document.querySelectorAll('.banner-slide');
                if (slides.length <= 1) return;

                let currentIndex = 0;
                setInterval(() => {
                    slides[currentIndex].classList.remove('current');
                    currentIndex = (currentIndex + 1) % slides.length;
                    slides[currentIndex].classList.add('current');
                }, 5000);
            }

            function getSelectedValues(selector) {
                return Array.from(document.querySelectorAll(selector + ':checked')).map(cb => cb.value);
            }

            function slugify(text) {
                return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            }

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function formatPrice(price) {
                return parseFloat(price).toFixed(2).replace('.', ',');
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>

</html>