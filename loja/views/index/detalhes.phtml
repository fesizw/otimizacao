<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Produto - Loja Virtual</title>

    <!-- CSS Crítico Inline para First Contentful Paint rápido -->
    <style>
        <?php include $_SERVER['DOCUMENT_ROOT'] . '/publico/css/critical.css'; ?>
    </style>

    <!-- Preload de fontes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- CSS não-crítico carregado de forma assíncrona -->
    <link rel="preload" href="/publico/css/bootstrap.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/publico/css/fontawesome.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="preload" href="/publico/css/style.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link href="/publico/css/bootstrap.min.css" rel="stylesheet">
        <link href="/publico/css/fontawesome.min.css" rel="stylesheet">
        <link href="/publico/css/style.min.css" rel="stylesheet">
    </noscript>
</head>

<body class="detalhes">

    <div class="main-container container py-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/">Produtos</a></li>
                <li class="breadcrumb-item active" id="breadcrumbProduct">Carregando...</li>
            </ol>
        </nav>

        <div class="row">
            <div class="col-md-6">
                <div class="product-gallery">
                    <img src="https://via.placeholder.com/600x500"
                        alt="Produto"
                        class="main-image img-fluid"
                        id="mainProductImage">
                </div>
            </div>

            <div class="col-md-6">
                <div class="product-info">
                    <h1 class="product-title" id="productTitle">Carregando...</h1>

                    <div class="rating-stars mb-2" id="productRating">
                    </div>

                    <div class="product-price h3 text-primary mb-3" id="productPrice">R$ --,--</div>

                    <div class="product-description mb-4" id="productDescription">
                        <p>Carregando descrição...</p>
                    </div>

                    <div class="quantity-selector mb-3">
                        <label for="quantityInput" class="me-2">Quantidade:</label>
                        <button class="btn btn-outline-secondary btn-sm" id="btnDecrease">-</button>
                        <input type="number" id="quantityInput" class="form-control d-inline-block mx-2"
                            value="1" min="1" max="10" style="width: 60px;">
                        <button class="btn btn-outline-secondary btn-sm" id="btnIncrease">+</button>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary btn-lg me-2" id="btnAddCart">
                            <i class="fas fa-shopping-cart me-2"></i>Adicionar ao Carrinho
                        </button>
                        <button class="btn btn-success btn-lg" id="btnBuyNow">
                            <i class="fas fa-bolt me-2"></i>Comprar Agora
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="product-tabs mt-5">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabDescription">Descrição</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSpecs">Especificações</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabShipping">Entrega</button>
                </li>
            </ul>
            <div class="tab-content p-3 border border-top-0">
                <div class="tab-pane fade show active" id="tabDescription">
                    <div id="detailedDescription">Carregando...</div>
                </div>
                <div class="tab-pane fade" id="tabSpecs">
                    <div id="technicalSpecs">Carregando especificações...</div>
                </div>
                <div class="tab-pane fade" id="tabShipping">
                    <p><strong>Entrega Grátis</strong> para todo o Brasil</p>
                    <p><strong>Prazo de entrega:</strong> 3-7 dias úteis</p>
                    <p><strong>Transportadora:</strong> Correios ou transportadora parceira</p>
                </div>
            </div>
        </div>

        <div class="reviews-section mt-5">
            <h3>Avaliações dos Clientes</h3>
            <div id="reviewsList" class="mt-3">
            </div>
        </div>

        <div class="related-products mt-5">
            <h3>Produtos Relacionados</h3>
            <div class="row mt-3" id="relatedProductsList">
            </div>
        </div>
    </div>

    <!-- Notificação -->
    <div class="notification-popup position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-body" id="notificationText"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/publico/js/jquery.min.js"></script>
    <script src="/publico/js/bootstrap.bundle.min.js"></script>

    <script>
        (function() {
            'use strict';

            const PRODUCT_ID = '<?= $this->id ?>';
            let currentProduct = null;

            const elements = {
                productTitle: document.getElementById('productTitle'),
                productPrice: document.getElementById('productPrice'),
                productDescription: document.getElementById('productDescription'),
                productRating: document.getElementById('productRating'),
                mainImage: document.getElementById('mainProductImage'),
                breadcrumb: document.getElementById('breadcrumbProduct'),
                detailedDescription: document.getElementById('detailedDescription'),
                technicalSpecs: document.getElementById('technicalSpecs'),
                reviewsList: document.getElementById('reviewsList'),
                relatedProducts: document.getElementById('relatedProductsList'),
                quantityInput: document.getElementById('quantityInput'),
                toast: document.getElementById('notificationToast'),
                toastText: document.getElementById('notificationText')
            };

            async function init() {
                try {
                    const response = await fetch(`/index/product/id/${PRODUCT_ID}`);
                    
                    if (!response.ok) {
                        elements.productTitle.textContent = 'Produto não encontrado';
                        return;
                    }

                    currentProduct = await response.json();

                    renderProduct();
                    renderSpecs();
                    renderReviews();
                    renderRelatedProducts();
                    setupEventListeners();
                } catch (error) {
                    console.error('Erro ao carregar produto:', error);
                    elements.productTitle.textContent = 'Erro ao carregar produto';
                }
            }

            function renderProduct() {
                elements.productTitle.textContent = currentProduct.nome;
                elements.productPrice.textContent = `R$ ${formatPrice(currentProduct.preco)}`;
                elements.productDescription.innerHTML = `<p>${escapeHtml(currentProduct.descricao)}</p>`;
                elements.detailedDescription.innerHTML = `<p>${escapeHtml(currentProduct.descricao)}</p>`;
                elements.breadcrumb.textContent = currentProduct.nome;

                if (currentProduct.imagem) {
                    elements.mainImage.src = currentProduct.imagem;
                    elements.mainImage.alt = currentProduct.nome;
                }

                const reviews = currentProduct.reviews || [];
                const avgRating = reviews.length > 0 ?
                    reviews.reduce((sum, r) => sum + parseInt(r.nota), 0) / reviews.length :
                    0;

                elements.productRating.innerHTML = renderStars(avgRating) +
                    ` <span class="text-muted">(${reviews.length} avaliações)</span>`;
            }

            function renderSpecs() {
                const specs = currentProduct.specs || {};
                const specKeys = Object.keys(specs);

                if (specKeys.length === 0) {
                    elements.technicalSpecs.innerHTML = '<p class="text-muted">Sem especificações disponíveis.</p>';
                    return;
                }

                elements.technicalSpecs.innerHTML = `
            <table class="table table-striped">
                <tbody>
                    ${specKeys.map(key => `
                        <tr>
                            <td><strong>${escapeHtml(key)}</strong></td>
                            <td>${escapeHtml(specs[key])}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
            }

            function renderReviews() {
                const reviews = currentProduct.reviews || [];

                if (reviews.length === 0) {
                    elements.reviewsList.innerHTML = '<p class="text-muted">Nenhuma avaliação ainda.</p>';
                    return;
                }

                elements.reviewsList.innerHTML = reviews.map(review => `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h6 class="card-title">${escapeHtml(review.cliente || 'Cliente')}</h6>
                        <small class="text-muted">${formatDate(review.data_review)}</small>
                    </div>
                    <div class="mb-2">${renderStars(review.nota)}</div>
                    <p class="card-text">${escapeHtml(review.comentario)}</p>
                </div>
            </div>
        `).join('');
            }

            function renderRelatedProducts() {
                const relacionados = currentProduct.relacionados || [];

                if (relacionados.length === 0) {
                    elements.relatedProducts.innerHTML = '<p class="text-muted">Sem produtos relacionados.</p>';
                    return;
                }

                elements.relatedProducts.innerHTML = relacionados.map(rel => {
                    const prod = rel.relacionado;
                    return `
                <div class="col-md-3 mb-3">
                    <div class="card h-100" onclick="window.location='/index/detalhes/id/${prod.id_produtos}'" style="cursor:pointer;">
                        <img src="${escapeHtml(prod.imagem || 'https://via.placeholder.com/200')}" 
                             class="card-img-top" alt="${escapeHtml(prod.nome)}" loading="lazy">
                        <div class="card-body">
                            <h6 class="card-title">${escapeHtml(prod.nome)}</h6>
                            <p class="card-text text-primary">R$ ${formatPrice(prod.preco)}</p>
                        </div>
                    </div>
                </div>
            `;
                }).join('');
            }

            function setupEventListeners() {
                document.getElementById('btnIncrease').addEventListener('click', () => {
                    const input = elements.quantityInput;
                    if (parseInt(input.value) < 10) input.value = parseInt(input.value) + 1;
                });

                document.getElementById('btnDecrease').addEventListener('click', () => {
                    const input = elements.quantityInput;
                    if (parseInt(input.value) > 1) input.value = parseInt(input.value) - 1;
                });

                document.getElementById('btnAddCart').addEventListener('click', () => {
                    showNotification('Produto adicionado ao carrinho!');
                });

                document.getElementById('btnBuyNow').addEventListener('click', () => {
                    showNotification('Redirecionando para o checkout...');
                });
            }

            function showNotification(message) {
                elements.toastText.textContent = message;
                const toast = new bootstrap.Toast(elements.toast);
                toast.show();
            }

            function renderStars(rating) {
                const fullStars = Math.floor(rating);
                const halfStar = rating % 1 >= 0.5;
                const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

                return '<i class="fas fa-star text-warning"></i>'.repeat(fullStars) +
                    (halfStar ? '<i class="fas fa-star-half-alt text-warning"></i>' : '') +
                    '<i class="far fa-star text-warning"></i>'.repeat(emptyStars);
            }

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function formatPrice(price) {
                return parseFloat(price).toFixed(2).replace('.', ',');
            }

            function formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR');
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>

</html>